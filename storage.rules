rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    match /logos/{gymId}/{fileName} {
      // Public read access for logos.
      allow read;

      // isGymAdmin checks if the user is an admin of the specified gym.
      function isGymAdmin(userId, gymId) {
        // Get the user's profile from Firestore.
        let userProfile = get(/databases/(default)/documents/users/$(userId)).data;
        // The user must have the 'gym-admin' role AND their gymId must match.
        return userProfile.role == 'gym-admin' && userProfile.gymId == gymId;
      }

      // Allow write if the user is authenticated and is an admin of this gym.
      allow write: if request.auth != null && isGymAdmin(request.auth.uid, gymId);
    }
  }
}
