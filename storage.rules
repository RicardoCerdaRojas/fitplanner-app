rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Allow public read access for all logos, as they need to be displayed in the app header for all users.
    match /logos/{allPaths=**} {
      allow read;
    }

    // Allow a user to write to a gym's logo path only if they are authenticated,
    // their user profile exists in Firestore, and their profile confirms they are an admin of that specific gym.
    // This explicit existence check is crucial to prevent silent failures.
    match /logos/{gymId}/{fileName} {
      allow write: if request.auth != null &&
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'gym-admin' &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.gymId == gymId;
    }
  }
}
