
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if a user is signed in
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Rules for the 'users' collection
    match /users/{userId} {
      // Anyone can create a user document (for sign-up).
      allow create: if true;
      // Any signed-in user can read any user profile.
      // This is needed for admins/coaches to see member lists.
      allow read: if isSignedIn();
      // Allow any write operation (including updates from webhooks).
      // This is a permissive rule for our current development stage.
      allow write: if true; 
    }
    
    // Rules for the 'gyms' collection
    match /gyms/{gymId} {
        // Any signed-in user can read gym profiles.
        // This is necessary for the AuthContext to load the gym theme and name.
        allow read: if isSignedIn();
        // Allow any authenticated user to create a gym or update one.
        // A stricter rule would check if request.auth.uid == resource.data.adminUid
        allow write: if isSignedIn();
    }
    
    // Generic rule for all other collections
    // This allows any signed-in user to perform any action on other collections
    // like memberships, routines, routineTypes, etc.
    match /{path=**}/documents/{document} {
      allow read, write: if isSignedIn();
    }
  }
}
