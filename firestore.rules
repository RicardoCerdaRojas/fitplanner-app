rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isGymAdmin(gymId) {
      let userData = getUserData();
      return isSignedIn() && userData.gymId == gymId && userData.role == 'gym-admin';
    }

    function isCoach(gymId) {
       let userData = getUserData();
       return isSignedIn() && userData.gymId == gymId && (userData.role == 'coach' || userData.role == 'gym-admin');
    }
    
    function isMemberOfGym(gymId) {
        return isSignedIn() && getUserData().gymId == gymId;
    }

    match /users/{userId} {
      // Allow any authenticated user to read user profiles.
      // This is necessary to allow cross-service rules (like from Storage)
      // to verify a user's role by reading their profile.
      allow read: if isSignedIn();
      // Only the user themselves can update their profile.
      allow update: if isUser(userId);
      // Any signed in user can create a user doc (during signup).
      allow create: if isSignedIn();
    }
    
    match /gyms/{gymId} {
        allow read: if isMemberOfGym(gymId);
        allow create, update: if isGymAdmin(gymId);
    }
    
    match /invites/{email} {
        allow create: if isGymAdmin(request.resource.data.gymId);
        allow read, delete: if isSignedIn();
    }
    
    match /routineTypes/{typeId} {
        allow read: if isMemberOfGym(get(/databases/$(database)/documents/routineTypes/$(typeId)).data.gymId);
        allow create, delete: if isGymAdmin(request.resource.data.gymId);
    }
    
    match /routines/{routineId} {
        allow create: if isCoach(request.resource.data.gymId);
        allow read, update: if (isCoach(resource.data.gymId) || isUser(resource.data.athleteId));
        allow delete: if isCoach(resource.data.gymId);
    }
  }
}
